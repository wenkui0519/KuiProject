(function(a,c){var b=function(d,e){this.editor=d;this.options=c.extend({},{source:[],delay:500,queryBy:"name",items:10},e);this.show=this.options.show||this.show;this.process=this.options.process||this.process;this.matcher=this.options.matcher||this.matcher;this.renderDropdown=this.options.renderDropdown||this.renderDropdown;this.cleanUp=this.options.cleanUp||this.cleanUp;this.highlightPreviousResult=this.options.highlightPreviousResult||this.highlightPreviousResult;this.highlightNextResult=this.options.highlightNextResult||this.highlightNextResult;this.render=this.options.render||this.render;this.insert=this.options.insert||this.insert;this.highlighter=this.options.highlighter||this.highlighter;this.query="";this.hasFocus=true;this.renderInput();this.bindEvents()};b.prototype={constructor:b,renderInput:function(){var d='<span id="autocomplete">'+'<span id="autocomplete-delimiter">'+this.options.delimiter+"</span>"+'<span id="autocomplete-searchtext"><span class="dummy">\uFEFF</span></span>'+"</span>";this.editor.execCommand("mceInsertContent",false,d);this.editor.focus();this.editor.selection.select(this.editor.selection.dom.select("span#autocomplete-searchtext span")[0]);this.editor.selection.collapse(0)},bindEvents:function(){this.editor.on("keyup",this.editorKeyUpProxy=c.proxy(this.rteKeyUp,this));this.editor.on("keydown",this.editorKeyDownProxy=c.proxy(this.rteKeyDown,this),true);this.editor.on("click",this.editorClickProxy=c.proxy(this.rteClicked,this));c("body").on("click",this.bodyClickProxy=c.proxy(this.rteLostFocus,this));c(this.editor.getWin()).on("scroll",this.rteScroll=c.proxy(function(){this.cleanUp(true)},this))},unbindEvents:function(){this.editor.off("keyup",this.editorKeyUpProxy);this.editor.off("keydown",this.editorKeyDownProxy);this.editor.off("click",this.editorClickProxy);c("body").off("click",this.bodyClickProxy);c(this.editor.getWin()).off("scroll",this.rteScroll)},rteKeyUp:function(f){switch(f.which||f.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 8:if(this.query===""){this.cleanUp(true)}else{this.lookup()}break;case 9:case 13:var d=(this.$dropdown!==undefined)?this.$dropdown.find("li.active"):[];if(d.length){this.select(d.data());this.cleanUp(false)}else{this.cleanUp(true)}break;case 27:this.cleanUp(true);break;default:this.lookup()}},rteKeyDown:function(d){switch(d.which||d.keyCode){case 9:case 13:case 27:d.preventDefault();break;case 38:d.preventDefault();if(this.$dropdown!==undefined){this.highlightPreviousResult()}break;case 40:d.preventDefault();if(this.$dropdown!==undefined){this.highlightNextResult()}break}d.stopPropagation()},rteClicked:function(f){var d=c(f.target);if(this.hasFocus&&d.parent().attr("id")!=="autocomplete-searchtext"){this.cleanUp(true)}},rteLostFocus:function(){if(this.hasFocus){this.cleanUp(true)}},lookup:function(){this.query=c.trim(c(this.editor.getBody()).find("#autocomplete-searchtext").text()).replace("\ufeff","");if(this.$dropdown===undefined){this.show()}clearTimeout(this.searchTimeout);this.searchTimeout=setTimeout(c.proxy(function(){var d=c.isFunction(this.options.source)?this.options.source(this.query,c.proxy(this.process,this),this.options.delimiter):this.options.source;if(d){this.process(d)}},this),this.options.delay)},matcher:function(d){return ~d[this.options.queryBy].toLowerCase().indexOf(this.query.toLowerCase())},sorter:function(f){var g=[],e=[],d=[],h;while((h=f.shift())!==undefined){if(!h[this.options.queryBy].toLowerCase().indexOf(this.query.toLowerCase())){g.push(h)}else{if(~h[this.options.queryBy].indexOf(this.query)){e.push(h)}else{d.push(h)}}}return g.concat(e,d)},highlighter:function(d){return d.replace(new RegExp("("+this.query.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")+")","ig"),function(e,f){return"<strong>"+f+"</strong>"})},show:function(){var d=this.editor.inline?this.offsetInline():this.offset();this.$dropdown=c(this.renderDropdown()).css({"top":d.top,"left":d.left});c("body").append(this.$dropdown);this.$dropdown.on("click",c.proxy(this.autoCompleteClick,this))},process:function(f){if(!this.hasFocus){return}var g=this,d=[],e=c.grep(f,function(h){return g.matcher(h)});e=g.sorter(e);e=e.slice(0,this.options.items);c.each(e,function(j,k){var h=c(g.render(k));h.html(h.html().replace(h.text(),g.highlighter(h.text())));c.each(e[j],function(i,l){if(i!="$$hashKey"){h.attr("data-"+i,l)}});d.push(h[0].outerHTML)});if(d.length){this.$dropdown.html(d.join("")).show()}else{this.$dropdown.hide()}},renderDropdown:function(){return'<ul class="rte-autocomplete dropdown-menu"><li class="loading"></li></ul>'},render:function(d){return"<li>"+'<a href="javascript:;"><span>'+d[this.options.queryBy]+"</span></a>"+"</li>"},autoCompleteClick:function(f){var d=c(f.target).closest("li").data();if(!c.isEmptyObject(d)){this.select(d);this.cleanUp(false)}f.stopPropagation();f.preventDefault()},highlightPreviousResult:function(){var d=this.$dropdown.find("li.active").index(),e=(d===0)?this.$dropdown.find("li").length-1:--d;this.$dropdown.find("li").removeClass("active").eq(e).addClass("active")
},highlightNextResult:function(){var d=this.$dropdown.find("li.active").index(),e=(d===this.$dropdown.find("li").length-1)?0:++d;this.$dropdown.find("li").removeClass("active").eq(e).addClass("active")},select:function(e){this.editor.focus();var d=this.editor.dom.select("span#autocomplete")[0];this.editor.dom.remove(d);this.editor.execCommand("mceInsertContent",false,this.insert(e));this.editor.selection.collapse()},insert:function(d){return"<span>"+d[this.options.queryBy]+"</span>&nbsp;"},cleanUp:function(e){this.unbindEvents();this.hasFocus=false;if(this.$dropdown!==undefined){this.$dropdown.remove();delete this.$dropdown}if(e){var h=this.query,d=c(this.editor.dom.select("span#autocomplete")),g=c("<p>"+this.options.delimiter+h+"</p>")[0].firstChild,f=c(this.editor.selection.getNode()).offset().top===(d.offset().top+((d.outerHeight()-d.height())/2));this.editor.dom.replace(g,d[0]);if(f){this.editor.selection.select(g);this.editor.selection.collapse()}}},offset:function(){var f=c(this.editor.getContainer()).offset(),d=c(this.editor.getContentAreaContainer()).position(),e=c(this.editor.dom.select("span#autocomplete")).position();return{top:f.top+d.top+e.top+c(this.editor.selection.getNode()).innerHeight()-c(this.editor.getDoc()).scrollTop()+5,left:f.left+d.left+e.left}},offsetInline:function(){var d=c(this.editor.dom.select("span#autocomplete")).offset();return{top:d.top+c(this.editor.selection.getNode()).innerHeight()+5,left:d.left}}};a.create("tinymce.plugins.Mention",{init:function(d){var f,g=d.getParam("mentions");g.delimiter=(g.delimiter!==undefined)?!c.isArray(g.delimiter)?[g.delimiter]:g.delimiter:["@"];function e(){var j=d.selection.getRng(true).startOffset,i=d.selection.getRng(true).startContainer.data||"",h=i.substr(j-1,1);return(!!c.trim(h).length)?false:true}d.on("keypress",function(h){var i=c.inArray(String.fromCharCode(h.which||h.keyCode),g.delimiter);if(i>-1&&e()){if(f===undefined||(f.hasFocus!==undefined&&!f.hasFocus)){h.preventDefault();f=new b(d,c.extend({},g,{delimiter:g.delimiter[i]}))}}})},getInfo:function(){return{longname:"mention",author:"Steven Devooght",version:a.majorVersion+"."+a.minorVersion}}});a.PluginManager.add("mention",a.plugins.Mention)}(tinymce,jQuery));